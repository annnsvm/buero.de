# Оновлені функціональні та нефункціональні вимоги (MVP v2)

**Узгодження з архітектурою:** цей документ приведено у відповідність до `docs/architecture.md`, `docs/modules/*.md` та `docs/auth-spec.md`.

---

## Частина 1. Функціональні вимоги

### Ф-001: Реєстрація та авторизація

**Пріоритет:** Критичний

**Опис**

Система повинна забезпечувати реєстрацію користувачів із ролями **Student** та **Teacher**. Авторизація через JWT (access + refresh); refresh зберігається в Postgres (таблиця `refresh_tokens`). Токени передаються в **cookie** (не в тілі JSON); при необхідності access можна передавати в заголовку `Authorization: Bearer`. Підтримка мови інтерфейсу: **en** | **de** (поле `users.language`). Можливість soft delete (GDPR) через `users.deleted_at`.

**Критерії прийняття**

- Реєстрація через email + password; хешування пароля (bcrypt)
- Access token (короткий TTL); refresh token у Postgres; revoke при logout (`revoked_at`)
- Некоректний/прострочений токен → 401
- Деталі: `docs/auth-spec.md`, `docs/auth-config.md`

---

### Ф-002: Placement Test (визначення рівня)

**Пріоритет:** Критичний

**Опис**

Один **глобальний** тест визначення рівня (A1–B2). Питання зберігаються в таблиці `placement_questions` (не прив'язані до курсу). Результат зберігається в `student_profiles.level`; після проходження активується **trial** (`trial_ends_at` або статус підписки `trialing`). Без проходження Placement Test та без активної підписки/trial доступ до списку курсів та контенту не надається.

**Критерії прийняття**

- Мінімум 20 питань (один набір для всього Placement Test)
- Автоматичне визначення рівня за результатами; збереження в профілі студента
- Після тесту — активація trial; доступ до курсів згідно з політикою підписки/trial

---

### Ф-003: Курси та матеріали (Core Feature)

**Пріоритет:** Критичний

**Опис**

Навчання організоване як **курси** (таблиця `courses`) з **матеріалами** (таблиця `course_materials`). Курс має категорію: **language** | **sociocultural** (розділ «Integration & Life in Germany» — це курси з `category = sociocultural`, не окрема підсистема). Типи матеріалів: **video** (YouTube), **vocabulary**, **grammar**, **quiz**, **scenario**, **cultural_insight**, **homework**, **text**. Будь-який вчитель може створювати, редагувати та видаляти будь-який курс (`teacher_id` лише «хто створив», не для обмеження доступу). Доступ до списку курсів та перегляду контенту — лише при **активній підписці або trial** (див. Ф-008, модуль Courses).

**Приклад курсу: "Renting an Apartment in Germany"** — матеріали: лексика, граматика, відео, сценарій діалогу, cultural_insight (наприклад Anmeldung).

**Критерії прийняття**

- Курс містить матеріали з order_index; мінімум один сценарій (type = scenario) за потреби
- Сценарій — інтерактивний вибір (decision-based); результат зберігається в `quiz_attempts` / `course_progress`

---

### Ф-004: Інтерактивні сценарії (Scenario Engine)

**Пріоритет:** Високий

**Опис**

Система повинна підтримувати сценарні уроки з гілками вибору (decision-based flow).

**Логіка**

1. Користувач отримує ситуацію
2. Обирає відповідь
3. Система показує наслідок
4. Дається культурне пояснення

**Критерії прийняття**

- Мінімум 3 гілки в одному сценарії
- Збереження результату
- Пояснення помилки при неправильній відповіді

---

### Ф-005: Прогрес користувача

**Пріоритет:** Високий

**Опис**

Прогрес зберігається в `course_progress` та `quiz_attempts` (покрокове збереження відповідей для можливості продовження квізу після переривання). Відображається: завершені матеріали/курси, відсоток правильних відповідей, поточний рівень (`student_profiles.level`), рекомендований наступний крок (модуль Progress & Quizzes).

---

### Ф-006: Домашні завдання

**Пріоритет:** Середній

**Опис**

Після проходження модуля користувач отримує завдання для самостійної роботи.

**Типи:**

- Написати короткий текст
- Відповісти на відкриті питання
- Підготувати діалог

---

### Ф-007: Запит на живий урок (спрощений)

**Пріоритет:** Середній

**Опис**

Студент створює запит на 1-1 заняття (таблиця `lesson_requests`). **Вчитель** (не адмін) переглядає запити, приймає (status = accepted, заповнюється teacher_id) або відхиляє (rejected). Після проведення заняття вчитель виставляє статус **completed** або **rejected**. Зв'язок із студентом після прийняття — поза платформою (email/телефон). Календар та автоматичне бронювання в MVP не реалізуються.

**Реалізація (MVP):** кнопка «Request a lesson», форма (бажаний час, повідомлення); статуси: pending → accepted/rejected → completed/rejected.

---

### Ф-008: Підписки через Stripe

**Пріоритет:** Критичний

**Опис**

Помісячна підписка через **Stripe Checkout**; керування підпискою — **Stripe Customer Portal** (картки не зберігаються на нашому боці). Webhook `POST /webhooks/stripe`: верифікація signature; ідемпотентність через таблицю `stripe_webhook_events` (stripe_event_id). Події: checkout.session.completed, invoice.paid, customer.subscription.updated/deleted. **Trial** активується після проходження Placement Test (`trial_ends_at` у student_profiles або status trialing). Доступ до курсів та контенту — лише при активній підписці або активному trial; при скасуванні підписки доступ блокується.

---

## Частина 2. Нефункціональні вимоги

### НФ-001: Продуктивність (Performance)

**Пріоритет:** Високий

**Опис**

Система повинна забезпечувати швидку обробку запитів та стабільну роботу при одночасному навантаженні.

**Вимоги**

| Область | Вимога |
|--------|--------|
| Час відповіді API | ≤ 500 мс для 95% запитів; ≤ 1 сек для складних сценарних запитів |
| Підтримка навантаження | мінімум 500 одночасних користувачів (MVP); масштабування через горизонтальне розширення |
| Час завантаження сторінки | ≤ 2 секунд при середньому з'єднанні |
| Обробка quiz-сценаріїв | перехід між гілками ≤ 300 мс |

**Метрики контролю:** API monitoring, log latency tracking, P95, P99 показники.

---

### НФ-002: Масштабованість (Scalability)

**Пріоритет:** Середній (стратегічно важливий)

**Опис**

Архітектура повинна дозволяти горизонтальне масштабування без зміни бізнес-логіки.

**Вимоги**

- Backend **stateless**: сесія = JWT (access + refresh у Postgres); **Redis у MVP не використовується** (architecture.md, Tech Stack).
- Підтримка масштабування через Docker / Kubernetes.
- База даних: індексація, оптимізація складних запитів; read-replicas — у майбутньому.
- Webhooks Stripe ідемпотентні (таблиця `stripe_webhook_events`).

---

### НФ-003: Безпека (Security)

**Пріоритет:** Критичний

**Опис**

Система повинна забезпечувати захист персональних даних та фінансових операцій.

**Вимоги**

| Область | Вимога |
|--------|--------|
| Передача даних | HTTPS (TLS 1.2+) |
| Зберігання паролів | bcrypt; мінімальна складність пароля |
| Авторизація | JWT (access + refresh); ротація refresh токенів; blacklist токенів при logout |
| Захист від атак | Rate limiting; CORS policy; захист від SQL injection (ORM / prepared statements); CSRF protection |
| Платежі | Дані карт не зберігаються; Stripe webhook перевіряється через signature verification |
| Доступ до контенту | список курсів та матеріали — лише при активній підписці або trial (architecture, модуль Courses) |
| Сценарні відповіді | перевірка прав доступу до модуля; за потреби — неможливість «перескочити» без проходження (course_progress, level) |

---

### НФ-004: Надійність (Reliability)

**Пріоритет:** Високий

**Опис**

Система повинна працювати стабільно та передбачувано.

**Вимоги**

- **Доступність:** мінімум 99% uptime
- **Обробка помилок:** централізований error handler; логування помилок; fallback response без розкриття внутрішньої логіки
- **Відмовостійкість:** Stripe webhook retry-safe; транзакційність записів у БД
- **Резервне копіювання:** щоденний backup БД; можливість відновлення протягом 24 годин

---

### НФ-005: Зручність використання (Usability)

**Пріоритет:** Високий

**Опис**

Інтерфейс повинен бути інтуїтивно зрозумілим та мінімізувати когнітивне навантаження.

**Вимоги**

| Область | Вимога |
|--------|--------|
| Onboarding | максимум 3 кроки до початку навчання; Placement Test запускається автоматично |
| Навігація | не більше 3 кліків до модуля; чітка візуалізація прогресу |
| Візуальна структура | мінімалістичний дизайн; фокус на сценарії |
| Mobile | коректна робота на мобільних пристроях |
| Feedback | миттєвий зворотний зв'язок при відповіді в quiz |

---

### НФ-006: Розширюваність (Extensibility)

**Пріоритет:** Середній

**Опис**

Система повинна дозволяти додавання нових мов, сценаріїв та модулів без зміни ядра системи.

**Вимоги**

- Модульна структура контенту
- Сценарії зберігаються в БД, а не в коді
- Можливість додати нову мову без переписування логіки
- Можливість додати новий тип завдання

---

### НФ-007: Логування та аналітика

**Пріоритет:** Середній

**Опис**

Система повинна забезпечувати можливість аналізу поведінки користувачів.

**Вимоги**

- **Логування:** входи користувачів; проходження модулів; результати quiz
- **Аналітика:** відсоток завершення модулів; середній час проходження; drop-off rate
- **Моніторинг:** серверні помилки; Stripe webhook статуси

---

### НФ-008: Сумісність (Compatibility)

**Вимоги**

- Chrome (останні 2 версії)
- Safari
- Firefox
- Edge
